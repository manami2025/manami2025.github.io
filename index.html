<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>スプレッドシート連携マップ</title>
  <style>
    #map {
      height: 600px;
      width: 100%;
    }
    #searchInput {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 5;
      width: 300px;
    }
  </style>
</head>
<body>
  <h2>スプレッドシートの場所をAdvancedMarkerElementで表示</h2>
  <div id="map"></div>

  <script>
    let map;
    let markers = [];
    let infoWindow;

    window.onload = () => {
      const timer = setInterval(() => {
        if (
          typeof google !== "undefined" &&
          typeof google.maps !== "undefined" &&
          google.maps.marker !== undefined
        ) {
          clearInterval(timer);
          initMap();
        }
      }, 300);
    };

    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 35.09647639047312, lng: 132.3470713278045 }, // 中心座標
        zoom: 16,
      });

      fetchSpreadsheetData();
    }

    function fetchSpreadsheetData() {
      const sheetApiUrl =
        "https://sheets.googleapis.com/v4/spreadsheets/1FHCb1dzPiDe6cULzTEGrAtAdmnkUc1TmdLUfu7KXX34/values/シート1?key=AIzaSyB07qN_gNdWzJtvprR3qI0qyQ6ol9AOMUk&libraries=places";

      fetch(sheetApiUrl)
        .then((res) => {
          if (!res.ok) throw new Error("HTTPエラー: " + res.status);
          return res.json();
        })
        .then((data) => processData(data))
        .catch((err) => console.error("❌ データ取得エラー:", err));
    }

    function processData(data) {
      if (!data.values || data.values.length < 2) {
        console.warn("データがありません");
        return;
      }

      const headers = data.values[0].map((h) => h.trim());
      const rows = data.values.slice(1);

      rows.forEach((row) => {
        const obj = {};
        headers.forEach((key, i) => {
          obj[key] = row[i] || "";
        });

        const lat = parseFloat(obj["緯度"]);
        const lng = parseFloat(obj["経度"]);
        if (isNaN(lat) || isNaN(lng)) return;

        const position = { lat, lng };
        const marker = new google.maps.marker.AdvancedMarkerElement({
          map,
          position,
          title: obj["場所"] || "不明な場所",
        });

        marker.addListener("click", () => {
          if (infoWindow) infoWindow.close();

          infoWindow = new google.maps.InfoWindow({
            content: `
              <div style="max-width:250px">
                <h3>${obj["場所"] || "名称なし"}</h3>
                <p><strong>カテゴリー:</strong> ${obj["カテゴリー"] || "不明"}</p>
                <p><strong>定休日:</strong> ${obj["定休日"] || "情報なし"}</p>
                <p><strong>営業時間:</strong> ${obj["営業時間"] || "情報なし"}</p>
                <p><strong>電話番号:</strong> ${obj["電話番号"] || "情報なし"}</p>
                ${
                  obj["HP"]
                    ? `<p><a href="${obj["HP"]}" target="_blank" rel="noopener noreferrer">ホームページ</a></p>`
                    : ""
                }
              </div>`,
          });

          infoWindow.open(map, marker);
        });

        markers.push(marker);
      });
    }
  </script>
</body>
</html>
