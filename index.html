<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>温泉津温泉 店舗マップ</title>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB07qN_gNdWzJtvprR3qI0qyQ6ol9AOMUk&libraries=places" async defer></script>
  <style>
    html, body { height:100%; margin:0; padding:0; font-family:'Segoe UI',sans-serif; }
    #map { height:600px; width:100%; border:1px solid #ddd; border-radius:8px; margin-top:20px; }
    h2 { color:#333; text-align:center; margin-top:20px; }
    p { text-align:center; color:#555; }
    #searchBox { display:block; width:80%; max-width:400px; margin:20px auto; padding:10px; border:1px solid #ccc; border-radius:5px; font-size:16px; }
    .gm-style-iw { font-family:'Segoe UI',sans-serif; }
    .gm-style-iw h2 { font-size:1.2em; margin-bottom:5px; color:#333; text-align:left; }
    .gm-style-iw p { font-size:0.9em; margin-bottom:3px; color:#666; text-align:left; }
    .gm-style-iw a { color:#007bff; text-decoration:none; }
    .gm-style-iw a:hover { text-decoration:underline; }
  </style>
</head>
<body>
  <h2>温泉津温泉 一覧マップ</h2>
  <p>温泉津温泉の宿泊、飲食、お土産屋さんをまとめました。リンクをクリックして詳細をご覧ください。</p>
  <input type="text" id="searchBox" placeholder="店舗名やカテゴリで検索" />
  <div id="map"></div>

  <script>
    let map;
    let markers = [];
    let bounds;
    let infoWindow;
    let allFacilities = [];

    const mapStyles = [ /*（省略：あなたのスタイルJSON）*/ ];
    const defaultCenter = { lat:35.09647639047312, lng:132.3470713278045 };
    const categoryColors = {
      "温泉・ケア":"red","買う":"blue","見る":"green","食べる":"purple",
      "遊ぶ・体験":"yellow","泊まる":"orange"
    };

    window.onload = function(){
      const interval = setInterval(()=>{
        if(window.google && google.maps){
          clearInterval(interval);
          initMap();
        }
      }, 500);
    };

    function initMap(){
      map = new google.maps.Map(document.getElementById("map"), {
        center: defaultCenter,
        zoom: 16,
        styles: mapStyles
      });
      document.getElementById("searchBox").addEventListener("input", filterMarkers);
      fetchSpreadsheetData();
    }

    function fetchSpreadsheetData(){
      const sheetApiUrl =
        "https://sheets.googleapis.com/v4/spreadsheets/1FHCb1dzPiDe6cULzTEGrAtAdmnkUc1TmdLUfu7KXX34/values/シート1?key=AIzaSyB07qN_gNdWzJtvprR3qI0qyQ6ol9AOMUk";
      fetch(sheetApiUrl)
        .then(response=>{
          if(!response.ok) throw new Error(`HTTPエラー: ${response.status}`);
          return response.json();
        })
        .then(data=>processData(data))
        .catch(error=>console.error("❌ データ取得エラー:", error));
    }

    function processData(data){
      const headers = data.values[0].map(h=>h.trim());
      const facilities = data.values.slice(1).map(row=>{
        const obj = {};
        headers.forEach((h,i)=> obj[h] = row[i] || "");
        return obj;
      });
      allFacilities = facilities;
      updateMapMarkers(facilities);
    }

    function getIconUrl(category){
      const c = categoryColors[category] || "gray";
      return `http://maps.google.com/mapfiles/ms/icons/${c}-dot.png`;
    }

    function updateMapMarkers(facilities){
      markers.forEach(m=>m.setMap(null));
      markers = [];
      bounds = new google.maps.LatLngBounds();
      if(infoWindow) infoWindow.close();

      facilities.forEach(f=>{
        const lat = parseFloat(f["緯度"]), lng = parseFloat(f["経度"]);
        const name = f["場所"] || "名称不明";
        const category = f["カテゴリー"] || "その他";
        if(isNaN(lat)||isNaN(lng)) return;

        const pos = new google.maps.LatLng(lat, lng);
        const marker = new google.maps.Marker({
          position: pos,
          map: map,
          title: name,
          icon: { url: getIconUrl(category) },
          label: {
            text: name.length>15 ? name.slice(0,15)+"…" : name,
            color:"#000", fontSize:"8px", fontWeight:"bold"
          }
        });

        marker.addListener("click", ()=>{
          if(infoWindow) infoWindow.close();
          let html = `<div style="max-width:300px;"><h2>${name}</h2>`;
          html += `<p><strong>カテゴリ:</strong> ${category}</p>`;
          html += `<p><strong>定休日:</strong> ${f["定休日"]||"なし"}</p>`;
          html += `<p><strong>営業時間:</strong> ${f["営業時間"]||"不明"}</p>`;
          html += `<p><strong>電話番号:</strong> ${f["電話番号"]||"なし"}</p>`;
          if(f["HP"]) html += `<p><a href="${f["HP"]}" target="_blank" rel="noopener noreferrer">ホームページを見る</a></p>`;
          html += `</div>`;
          infoWindow = new google.maps.InfoWindow({content:html});
          infoWindow.open(map, marker);
        });

        markers.push(marker);
        bounds.extend(pos);
      });

      if(markers.length){
        map.fitBounds(bounds);
        if(map.getZoom()<17) map.setZoom(17);
      } else {
        map.setCenter(defaultCenter);
        map.setZoom(15);
      }
    }

    function filterMarkers(){
      const kw = document.getElementById("searchBox").value.toLowerCase();
      const filtered = allFacilities.filter(f=>{
        const p = f["場所"]?.toLowerCase()||"",
              c = f["カテゴリー"]?.toLowerCase()||"";
        return p.includes(kw)||c.includes(kw);
      });
      updateMapMarkers(filtered);
    }
  </script>
</body>
</html>
