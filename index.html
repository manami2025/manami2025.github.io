<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æ¸©æ³‰æ´¥æ¸©æ³‰ åº—èˆ—ãƒãƒƒãƒ—</title>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB07qN_gNdWzJtvprR3qI0qyQ6ol9AOMUk&libraries=places" async defer></script>
  <style>
    /* å…¨ä½“è¨­å®š */
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      display: flex;
      flex-direction: column;
      min-height: 100vh; /* å°‘ãªãã¨ã‚‚ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆã®é«˜ã•å…¨ä½“ã‚’ä½¿ã† */
      background-color: #f8f8f8; /* èƒŒæ™¯è‰²ã‚’è¿½åŠ ã—ã€çµ±ä¸€æ„Ÿã‚’å‡ºã™ */
      color: #333;
    }

    /* ãƒ˜ãƒƒãƒ€ãƒ¼ã¨èª¬æ˜æ–‡ */
    h2 {
      color: #2c3e50; /* å°‘ã—æ¿ƒã„ã‚ã®è‰² */
      text-align: center;
      margin: 25px 15px 10px; /* ä¸Šä¸‹ã®ãƒãƒ¼ã‚¸ãƒ³ã‚’èª¿æ•´ */
      font-size: 2.2em; /* ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã§å¤§ãã‚ã« */
      letter-spacing: 0.05em; /* æ–‡å­—é–“éš” */
    }
    p {
      text-align: center;
      color: #555;
      margin: 0 15px 25px; /* ä¸Šä¸‹ã®ãƒãƒ¼ã‚¸ãƒ³ã‚’èª¿æ•´ */
      padding: 0;
      font-size: 1.1em;
      line-height: 1.6;
    }

    /* æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹ */
    #searchBox {
      display: block;
      width: 90%;
      max-width: 450px; /* å°‘ã—æœ€å¤§å¹…ã‚’åºƒã’ã‚‹ */
      margin: 0px auto 30px auto; /* ãƒãƒƒãƒ—ã¨ã®é–“éš”ã‚’åºƒã’ã‚‹ */
      padding: 12px 15px; /* å†…å´ã®ä½™ç™½ã‚’å¢—ã‚„ã™ */
      border: 1px solid #aeb6bf; /* æ ç·šã‚’å°‘ã—æ¿ƒã */
      border-radius: 8px; /* è§’ã‚’ä¸¸ã */
      font-size: 1.1em; /* ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’å¤§ãã */
      box-shadow: 0 2px 5px rgba(0,0,0,0.1); /* å½±ã‚’è¿½åŠ  */
      box-sizing: border-box; /* paddingã¨borderã‚’widthã«å«ã‚ã‚‹ */
    }
    #searchBox::placeholder { /* ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã®è‰² */
        color: #888;
    }

    /* ãƒãƒƒãƒ—ã‚³ãƒ³ãƒ†ãƒŠ */
    #map {
      flex-grow: 1; /* æ®‹ã‚Šã®ã‚¹ãƒšãƒ¼ã‚¹ã‚’åŸ‹ã‚ã‚‹ã‚ˆã†ã«ãƒãƒƒãƒ—ã‚’æ‹¡å¼µ */
      /* calc() ã‚’ä½¿ã£ã¦ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆã®é«˜ã•ã‹ã‚‰ãƒ˜ãƒƒãƒ€ãƒ¼ã¨æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹ã®åˆ†ã‚’å¼•ã */
      height: calc(100vh - (25px + 10px + 25px + 30px + 12px*2 + 1px*2 + 25px)); /* h2 + p + searchBox + margin/paddingã®åˆè¨ˆé«˜ã•ã‚’æ¦‚ç®—ã§å¼•ã */
      min-height: 480px; /* æœ€å°é«˜ã•ã‚’ç¢ºä¿ */
      width: 100%;
      border: 1px solid #ccc;
      border-radius: 8px;
      overflow: hidden; /* è§’ä¸¸ã§åœ°å›³ãŒã¯ã¿å‡ºã•ãªã„ã‚ˆã†ã« */
      box-shadow: 0 4px 8px rgba(0,0,0,0.15); /* å½±ã‚’å°‘ã—å¼·ã‚ã‚‹ */
    }

    /* InfoWindowã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .gm-style-iw {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      font-size: 1em; /* ãƒ™ãƒ¼ã‚¹ã®ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’ç¢ºä¿ */
    }
    .gm-style-iw h2 {
      font-size: 1.4em; /* InfoWindowã®H2ã‚’å¤§ãã */
      margin-top: 0;
      margin-bottom: 8px;
      color: #2c3e50;
      text-align: left;
      line-height: 1.3;
    }
    .gm-style-iw p {
      font-size: 1em; /* InfoWindowã®Pã‚’èª­ã¿ã‚„ã™ã */
      margin-bottom: 5px;
      color: #666;
      text-align: left;
      line-height: 1.5;
      padding: 0; /* è¦ªã‹ã‚‰ç¶™æ‰¿ã•ã‚Œã‚‹paddingã‚’ãƒªã‚»ãƒƒãƒˆ */
    }
    .gm-style-iw strong {
        color: #444; /* å¼·èª¿è¡¨ç¤ºã‚’å°‘ã—æ¿ƒã */
    }
    .gm-style-iw a {
      color: #3498db; /* ãƒªãƒ³ã‚¯è‰²ã‚’èª¿æ•´ */
      text-decoration: none;
      font-weight: bold;
    }
    .gm-style-iw a:hover {
      text-decoration: underline;
    }
    .gm-style-iw iframe { /* InfoWindowå†…ã®iframeã®ã‚¹ã‚¿ã‚¤ãƒ« */
        width: 100%;
        max-width: 300px; /* ã‚¤ãƒ³ãƒ•ã‚©ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã®å¹…ã«åˆã‚ã›ã¦æœ€å¤§å¹…ã‚’è¨­å®š */
        height: 180px; /* å›ºå®šé«˜ã• */
        border: none;
        margin-top: 10px;
        border-radius: 4px;
    }


    /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ (ãƒ¡ãƒ‡ã‚£ã‚¢ã‚¯ã‚¨ãƒª) */

    /* ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³å‘ã‘ (ç”»é¢å¹… 768px ä»¥ä¸‹) */
    @media (max-width: 768px) {
      h2 {
        font-size: 1.8em; /* ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ã§å¤§ãã */
        margin-top: 20px;
        margin-bottom: 8px;
      }
      p {
        font-size: 1em; /* ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ã§èª­ã¿ã‚„ã™ã */
        margin-bottom: 20px;
      }
      #searchBox {
        width: 95%; /* ç”»é¢ã®ç«¯ã¾ã§åºƒã’ã‚‹ */
        font-size: 1.05em; /* è¦‹ã‚„ã™ã„ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚º */
        padding: 10px 12px; /* ã‚¿ãƒƒãƒ—ã—ã‚„ã™ã */
      }
      #map {
        /* ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ã§ã¯ã€ãƒ˜ãƒƒãƒ€ãƒ¼ã¨æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹ã®é«˜ã•ãŒç¸®ã‚€ãŸã‚ã€ãƒãƒƒãƒ—ã®é«˜ã•ã‚’ç›¸å¯¾çš„ã«å¤§ããã™ã‚‹ */
        height: calc(100vh - (20px + 8px + 20px + 30px + 10px*2 + 1px*2 + 15px)); /* h2+p+searchBoxã®åˆè¨ˆã‚’æ¦‚ç®—ã§å¼•ã */
        min-height: 350px; /* æœ€å°é«˜ã•ã‚’èª¿æ•´ */
      }
      .gm-style-iw h2 {
        font-size: 1.2em; /* InfoWindowã®H2ã‚’èª¿æ•´ */
      }
      .gm-style-iw p {
        font-size: 0.9em; /* InfoWindowã®Pã‚’èª¿æ•´ */
      }
      .gm-style-iw iframe {
        height: 150px; /* ãƒ¢ãƒã‚¤ãƒ«å‘ã‘iframeé«˜ã• */
      }
    }

    /* éå¸¸ã«å°ã•ã„ç”»é¢å‘ã‘ (ç”»é¢å¹… 480px ä»¥ä¸‹) */
    @media (max-width: 480px) {
      h2 {
        font-size: 1.6em; /* ã•ã‚‰ã«å°ã•ã */
        margin-top: 15px;
      }
      p {
        font-size: 0.95em; /* ã•ã‚‰ã«èª¿æ•´ */
      }
      #searchBox {
        font-size: 1em;
        padding: 8px 10px;
      }
      #map {
        /* ã•ã‚‰ã«å°ã•ã„ç”»é¢ã§ã®ãƒãƒƒãƒ—é«˜ã•èª¿æ•´ */
        height: calc(100vh - (15px + 8px + 15px + 30px + 8px*2 + 1px*2 + 10px)); /* ã‚ˆã‚Šå³å¯†ãªæ¦‚ç®— */
        min-height: 280px; /* æœ€å°é«˜ã•ã‚’ã•ã‚‰ã«èª¿æ•´ */
      }
      .gm-style-iw h2 {
        font-size: 1.1em;
      }
      .gm-style-iw p {
        font-size: 0.85em;
      }
      .gm-style-iw iframe {
        height: 120px; /* éå¸¸ã«å°ã•ã„ç”»é¢å‘ã‘iframeé«˜ã• */
      }
    }
  </style>
</head>
<body>
  <h2>æ¸©æ³‰æ´¥æ¸©æ³‰ ä¸€è¦§ãƒãƒƒãƒ—</h2>
  <p>æ¸©æ³‰æ´¥æ¸©æ³‰ã®å®¿æ³Šã€é£²é£Ÿã€ãŠåœŸç”£å±‹ã•ã‚“ã‚’ã¾ã¨ã‚ã¾ã—ãŸã€‚ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦è©³ç´°ã‚’ã”è¦§ãã ã•ã„ã€‚</p>
  <input type="text" id="searchBox" placeholder="åº—èˆ—åã‚„ã‚«ãƒ†ã‚´ãƒªã§æ¤œç´¢" />
  <div id="map"></div>

  <script>
    let map;
    let markers = [];
    let infoWindow;
    let allFacilities = [];

    // æ¸©æ³‰æ´¥æ¸©æ³‰ã®æ¨å¥¨ã•ã‚Œã‚‹ä¸­å¿ƒåº§æ¨™ (initMapã¨updateMapMarkersã§ä¸€è²«ã—ã¦ä½¿ç”¨)
    const defaultCenter = { lat: 35.0963915628715, lng: 132.34470995757528 };
    const defaultZoom = 16; // åŸºæœ¬ã®ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«
    const singleMarkerZoom = 17; // å˜ä¸€ãƒãƒ¼ã‚«ãƒ¼è¡¨ç¤ºæ™‚ã®ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«

    // ã‚«ãƒ†ã‚´ãƒªãƒ¼åˆ¥ã«ã‚¢ã‚¤ã‚³ãƒ³è‰²ã‚’å®šç¾©
    const categoryColors = {
      "æ¸©æ³‰ãƒ»ã‚±ã‚¢": "red",
      "è²·ã†": "blue",
      "è¦‹ã‚‹": "green",
      "é£Ÿã¹ã‚‹": "purple",
      "éŠã¶ãƒ»ä½“é¨“": "yellow",
      "æ³Šã¾ã‚‹": "orange"
    };

    // Google Maps APIã®ãƒ­ãƒ¼ãƒ‰ã‚’å¾…ã¤
    window.onload = function () {
      console.log("ğŸ”„ Google Maps API ãƒ­ãƒ¼ãƒ‰å¾…æ©Ÿä¸­...");
      let checkGoogleMaps = setInterval(() => {
        if (typeof google !== "undefined" && typeof google.maps !== "undefined") {
          clearInterval(checkGoogleMaps);
          console.log("âœ… Google Maps API ãƒ­ãƒ¼ãƒ‰å®Œäº†ã€‚initMap() é–‹å§‹ã€‚");
          initMap();
        }
      }, 200); // ãƒã‚§ãƒƒã‚¯é–“éš”ã‚’çŸ­ãã—ã¦ç´ æ—©ãèµ·å‹•
    };

    function initMap() {
      const mapElement = document.getElementById("map");
      if (!mapElement) {
          console.error("âŒ ãƒãƒƒãƒ—è¦ç´  (#map) ãŒHTMLã«è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");
          return;
      }

      map = new google.maps.Map(mapElement, {
        center: defaultCenter, // å¸¸ã«ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ä¸­å¿ƒã«è¨­å®š
        zoom: defaultZoom,     // å¸¸ã«ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚ºãƒ¼ãƒ ã«è¨­å®š
        styles: mapStyles,
        disableDefaultUI: false, // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆUIã¯è¡¨ç¤ºï¼ˆã‚ºãƒ¼ãƒ ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãªã©ï¼‰
        mapTypeControl: false,  // ãƒãƒƒãƒ—ã‚¿ã‚¤ãƒ—ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚’éè¡¨ç¤º
        streetViewControl: false, // ã‚¹ãƒˆãƒªãƒ¼ãƒˆãƒ“ãƒ¥ãƒ¼ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚’éè¡¨ç¤º
        fullscreenControl: false // ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚’éè¡¨ç¤º
      });

      // æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
      const searchBox = document.getElementById("searchBox");
      if (searchBox) {
          searchBox.addEventListener("input", filterMarkers);
          console.log("âœ… æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®šå®Œäº†ã€‚");
      } else {
          console.warn("âš ï¸ æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹ (#searchBox) ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");
      }
      
      fetchSpreadsheetData();
    }

    function fetchSpreadsheetData() {
      // **é‡è¦: Google Sheets APIã‚­ãƒ¼ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã«ã¤ã„ã¦**
      // ã“ã®APIã‚­ãƒ¼ã¯å…¬é–‹ã•ã‚Œã¦ãŠã‚Šã€ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®èª­ã¿å–ã‚Šæ¨©é™ã‚’æŒã£ã¦ã„ã¾ã™ã€‚
      // æœ¬ç•ªç’°å¢ƒã§ä½¿ç”¨ã™ã‚‹éš›ã¯ã€æ‚ªç”¨ã‚’é˜²ããŸã‚ä»¥ä¸‹ã‚’å¼·ãæ¨å¥¨ã—ã¾ã™:
      // 1. Google Cloud Platformã§APIã‚­ãƒ¼ã«HTTPãƒªãƒ•ã‚¡ãƒ©ãƒ¼åˆ¶é™ã‚’è¨­å®šã™ã‚‹ (ã‚ãªãŸã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã®ã¿è¨±å¯)
      // 2. ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å‡¦ç†ã—ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã«APIã‚­ãƒ¼ã‚’å…¬é–‹ã—ãªã„
      const sheetApiUrl =
        "https://sheets.googleapis.com/v4/spreadsheets/1FHCb1dzPiDe6cULzTEGrAtAdmnkUc1TmdLUfu7KXX34/values/ã‚·ãƒ¼ãƒˆ1?key=AIzaSyB07qN_gNdWzJtvprR3qI0qyQ6ol9AOMUk";

      console.log("ğŸ”„ ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­:", sheetApiUrl);

      fetch(sheetApiUrl)
        .then((response) => {
          if (!response.ok) {
            // HTTPã‚¨ãƒ©ãƒ¼ã®è©³ç´°ã‚’ãƒ­ã‚°å‡ºåŠ›
            return response.text().then(text => { throw new Error(`HTTPã‚¨ãƒ©ãƒ¼ ${response.status}: ${text}`); });
          }
          return response.json();
        })
        .then((data) => processData(data))
        .catch((error) => console.error("âŒ ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:", error.message));
    }

    function processData(data) {
      if (!data || !data.values || data.values.length < 1) {
          console.error("âŒ ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ãŒç©ºã¾ãŸã¯ä¸æ­£ãªå½¢å¼ã§ã™ã€‚", data);
          allFacilities = []; // ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã‚‚ç©ºé…åˆ—ã§åˆæœŸåŒ–
          updateMapMarkers([]); // ãƒãƒ¼ã‚«ãƒ¼ã‚’ã‚¯ãƒªã‚¢
          return;
      }

      const headers = data.values[0].map(h => h.trim());
      console.log("ğŸ” ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼:", headers);

      // ãƒ‡ãƒ¼ã‚¿è¡ŒãŒãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã—ã‹ãªã„å ´åˆã‚‚è€ƒæ…®
      const facilities = data.values.slice(1).map(row => {
        let obj = {};
        headers.forEach((h, i) => {
          obj[h] = row[i] || "";
        });
        return obj;
      });
      allFacilities = facilities; // å…¨æ–½è¨­ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
      console.log(`âœ… ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰ ${allFacilities.length} ä»¶ã®æ–½è¨­ãƒ‡ãƒ¼ã‚¿ã‚’å‡¦ç†ã—ã¾ã—ãŸã€‚`);
      updateMapMarkers(allFacilities); // åˆæœŸè¡¨ç¤ºã¯å…¨ä»¶è¡¨ç¤º
    }

    // Googleãƒãƒƒãƒ—ã®ãƒ‰ãƒƒãƒˆã‚¢ã‚¤ã‚³ãƒ³URLã¯éæ¨å¥¨ã«ãªã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
    // å°†æ¥çš„ã«ã¯ã‚«ã‚¹ã‚¿ãƒ ã‚¢ã‚¤ã‚³ãƒ³ã®ä½¿ç”¨ã‚’æ¨å¥¨ã—ã¾ã™ã€‚
    function getIconUrl(category) {
      const color = categoryColors[category] || "grey"; // æœªå®šç¾©ã‚«ãƒ†ã‚´ãƒªãƒ¼ã¯ç°è‰²
      return `http://maps.google.com/mapfiles/ms/icons/${color}-dot.png`;
    }

    function updateMapMarkers(facilitiesToDisplay) {
      console.log(`ğŸ”„ ãƒãƒ¼ã‚«ãƒ¼ã®æ›´æ–°: ${facilitiesToDisplay.length} ä»¶è¡¨ç¤º`);

      // æ—¢å­˜ã®ãƒãƒ¼ã‚«ãƒ¼ã‚’å…¨ã¦ã‚¯ãƒªã‚¢
      markers.forEach(marker => marker.setMap(null));
      markers = [];

      // é–‹ã„ã¦ã„ã‚‹ã‚¤ãƒ³ãƒ•ã‚©ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’é–‰ã˜ã‚‹
      if (infoWindow) {
        infoWindow.close();
        infoWindow = null; // å‚ç…§ã‚’ã‚¯ãƒªã‚¢
      }

      // æ–°ã—ã„ãƒãƒ¼ã‚«ãƒ¼ã‚’è¿½åŠ 
      facilitiesToDisplay.forEach(facility => {
        const lat = parseFloat(facility["ç·¯åº¦"]);
        const lng = parseFloat(facility["çµŒåº¦"]);
        const name = facility["å ´æ‰€"] || "åç§°ä¸æ˜";
        const category = facility["ã‚«ãƒ†ã‚´ãƒªãƒ¼"] || "ãã®ä»–";

        if (isNaN(lat) || isNaN(lng)) {
          console.warn(`âš ï¸ ç·¯åº¦ã¾ãŸã¯çµŒåº¦ãŒç„¡åŠ¹ã§ã™ã€‚ãƒãƒ¼ã‚«ãƒ¼ãŒä½œæˆã•ã‚Œã¾ã›ã‚“: ${name}, ç·¯åº¦: ${facility["ç·¯åº¦"]}, çµŒåº¦: ${facility["çµŒåº¦"]}`);
          return;
        }

        const position = new google.maps.LatLng(lat, lng);
        const marker = new google.maps.Marker({
          position: position,
          map: map,
          title: name,
          icon: {
            url: getIconUrl(category),
            scaledSize: new google.maps.Size(32, 32) // ã‚¢ã‚¤ã‚³ãƒ³ã‚µã‚¤ã‚ºã‚’èª¿æ•´
          },
          label: {
            text: name.length > 15 ? name.slice(0, 15) + "â€¦" : name,
            color: "#000",
            fontSize: "12px", // ãƒ©ãƒ™ãƒ«ã®ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’å¤§ãã
            fontWeight: "bold",
          },
          animation: google.maps.Animation.DROP // ãƒãƒ¼ã‚«ãƒ¼ãŒãƒ‰ãƒ­ãƒƒãƒ—ã™ã‚‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
        });

        // ã‚¤ãƒ³ãƒ•ã‚©ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã®HTMLã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ä½œæˆ
        let infoHtml = `
          <div class="info-window">
            <h3>${name}</h3>
            <p><strong>ã‚«ãƒ†ã‚´ãƒª:</strong> ${category}</p>
            <p><strong>å®šä¼‘æ—¥:</strong> ${facility["å®šä¼‘æ—¥"] || "ãªã—"}</p>
            <p><strong>å–¶æ¥­æ™‚é–“:</strong> ${facility["å–¶æ¥­æ™‚é–“"] || "ä¸æ˜"}</p>
            <p><strong>é›»è©±ç•ªå·:</strong> ${facility["é›»è©±ç•ªå·"] || "ãªã—"}</p>
            ${facility["HP"] ? `<p><a href="${facility["HP"]}" target="_blank" rel="noopener noreferrer">ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã‚’è¦‹ã‚‹</a></p>` : ''}
            <p><a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(facility["å ´æ‰€"] + " " + facility["ä½æ‰€"])}" target="_blank" rel="noopener noreferrer">Googleãƒãƒƒãƒ—ã§è©³ç´°ã‚’è¦‹ã‚‹</a></p>
          </div>
        `;

        // ãƒãƒ¼ã‚«ãƒ¼ã‚¯ãƒªãƒƒã‚¯ã§ã‚¤ãƒ³ãƒ•ã‚©ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’é–‹ã
        marker.addListener("click", () => {
          if (infoWindow) {
            infoWindow.close();
          }
          infoWindow = new google.maps.InfoWindow({ content: infoHtml });
          infoWindow.open(map, marker);
          console.log(`ğŸ’¬ ã‚¤ãƒ³ãƒ•ã‚©ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦è¡¨ç¤º: ${name}`);
        });

        markers.push(marker);
      });

      // ãƒãƒ¼ã‚«ãƒ¼ãŒãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸå¾Œã‚‚ã€ãƒãƒƒãƒ—ã®ä¸­å¿ƒã¨ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«ã‚’å›ºå®šã™ã‚‹
      // fitBoundsã¯ä½¿ã‚ãªã„ã“ã¨ã§ã€æ„å›³ã—ãªã„ä¸­å¿ƒã®ãšã‚Œã‚’é˜²ã
      if (facilitiesToDisplay.length > 0) {
          // ãƒãƒ¼ã‚«ãƒ¼ãŒ1ã¤ã®å ´åˆã¯ã€ãã®ãƒãƒ¼ã‚«ãƒ¼ã‚’ä¸­å¿ƒã«å°‘ã—è©³ç´°ã«ã‚ºãƒ¼ãƒ 
          if (facilitiesToDisplay.length === 1) {
              map.setCenter(markers[0].getPosition());
              map.setZoom(singleMarkerZoom); // å˜ä¸€ãƒãƒ¼ã‚«ãƒ¼ã«æœ€é©ãªã‚ºãƒ¼ãƒ 
              console.log(`ğŸ—ºï¸ 1ã¤ã®ãƒãƒ¼ã‚«ãƒ¼ã‚’ä¸­å¿ƒã«ã‚ºãƒ¼ãƒ è¨­å®š (Zoom: ${singleMarkerZoom})`);
          } else {
              // è¤‡æ•°ã®ãƒãƒ¼ã‚«ãƒ¼ãŒã‚ã‚‹å ´åˆã¯ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ä¸­å¿ƒã¨ã‚ºãƒ¼ãƒ ã«è¨­å®š
              map.setCenter(defaultCenter);
              map.setZoom(defaultZoom);
              console.log(`ğŸ—ºï¸ è¤‡æ•°ãƒãƒ¼ã‚«ãƒ¼ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ä¸­å¿ƒã«è¨­å®š (Zoom: ${defaultZoom})`);
          }
      } else {
          // ãƒãƒ¼ã‚«ãƒ¼ãŒãªã„å ´åˆï¼ˆæ¤œç´¢çµæœãŒ0ä»¶ãªã©ï¼‰ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®å ´æ‰€ã«ã‚ºãƒ¼ãƒ 
          map.setCenter(defaultCenter);
          map.setZoom(defaultZoom);
          console.log(`ğŸ—ºï¸ ãƒãƒ¼ã‚«ãƒ¼ãªã—ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ä¸­å¿ƒã«è¨­å®š (Zoom: ${defaultZoom})`);
      }
    }

    function filterMarkers() {
      const keyword = document.getElementById("searchBox").value.toLowerCase().trim();
      console.log(`ğŸ” æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: "${keyword}"`);

      let filteredFacilities = [];
      if (keyword === "") {
          // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒç©ºã®å ´åˆã¯å…¨ã¦ã®æ–½è¨­ã‚’è¡¨ç¤º
          filteredFacilities = allFacilities;
          console.log("ğŸ—‘ï¸ æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒç©ºã®ãŸã‚ã€å…¨æ–½è¨­ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚");
      } else {
          // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã«åŸºã¥ã„ã¦ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
          filteredFacilities = allFacilities.filter(facility => {
            const place = facility["å ´æ‰€"] ? facility["å ´æ‰€"].toLowerCase() : "";
            const category = facility["ã‚«ãƒ†ã‚´ãƒªãƒ¼"] ? facility["ã‚«ãƒ†ã‚´ãƒªãƒ¼"].toLowerCase() : "";
            const address = facility["ä½æ‰€"] ? facility["ä½æ‰€"].toLowerCase() : "";
            const description = facility["èª¬æ˜"] ? facility["èª¬æ˜"].toLowerCase() : "";

            return (
              place.includes(keyword) ||
              category.includes(keyword) ||
              address.includes(keyword) ||
              description.includes(keyword)
            );
          });
          console.log(`âœ… ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼çµæœ: ${filteredFacilities.length} ä»¶`);
      }
      
      updateMapMarkers(filteredFacilities);
    }
  </script>
</body>
</html>
