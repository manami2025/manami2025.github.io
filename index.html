<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>æ¸©æ³‰æ´¥æ¸©æ³‰ã€€åº—èˆ—ãƒãƒƒãƒ—</title>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAE5sybi3eDWilyCfnTjto8iKzOezd9ivA=places" async defer></script>
    <style>
        #map {
            width: 100%;
            height: 800px;
            min-height: 500px;
            background-color: #e0e0e0;
            position: relative;
        }
        .info-window iframe {
            width: 100%;
            height: 200px;
            border: none;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <h2>æ¸©æ³‰æ´¥æ¸©æ³‰ã€€ä¸€è¦§ãƒãƒƒãƒ—</h2>
    <p>æ¸©æ³‰æ´¥æ¸©æ³‰ã®å®¿æ³Šã€é£²é£Ÿã€ãŠåœŸç”£å±‹ã•ã‚“ã‚’ã¾ã¨ã‚ã¾ã—ãŸã€‚ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦è©³ç´°ã‚’ã”è¦§ãã ã•ã„ã€‚</p>
    <div id="map"></div>

    <script>
        let map;
        let markers = [];
        let bounds;
        let infoWindow;

        window.onload = function() {
            console.log("ğŸ”„ Google Maps API ã®ãƒ­ãƒ¼ãƒ‰ã‚’ç¢ºèª");
            let checkGoogleMaps = setInterval(() => {
                if (typeof google !== "undefined" && typeof google.maps !== "undefined") {
                    clearInterval(checkGoogleMaps);
                    initMap();
                }
            }, 500);
        };

        function initMap() {
            console.log("âœ… initMap() é–‹å§‹");

            const mapElement = document.getElementById("map");
            if (!mapElement) {
                console.error("âŒ #map ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");
                return;
            }

            map = new google.maps.Map(mapElement, {
                center: { lat: 34.144389, lng: 131.429866 },
                zoom: 14
            });

            console.log("âœ… Google ãƒãƒƒãƒ—ãŒæ­£å¸¸ã«èª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸ");
            fetchSpreadsheetData();
        }

        function fetchSpreadsheetData() {
            const sheetApiUrl = "https://sheets.googleapis.com/v4/spreadsheets/1FHCb1dzPiDe6cULzTEGrAtAdmnkUc1TmdLUfu7KXX34/values/%E3%82%B7%E3%83%BC%E3%83%881?key=AIzaSyB07qN_gNdWzJtvprR3qI0qyQ6ol9AOMUk";

            console.log("ğŸ”„ Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆAPIãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡:", sheetApiUrl);

            fetch(sheetApiUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(HTTPã‚¨ãƒ©ãƒ¼: ${response.status});
                    }
                    return response.json();
                })
                .then(data => processData(data))
                .catch(error => console.error("âŒ ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:", error.message));
        }

        function processData(data) {
            console.log("âœ… å–å¾—ãƒ‡ãƒ¼ã‚¿:", data);

            if (!data || !data.values || !Array.isArray(data.values) || data.values.length < 2) {
                console.error("âš ï¸ ãƒ‡ãƒ¼ã‚¿ãŒä¸æ­£ã¾ãŸã¯ç©ºã§ã™", data);
                return;
            }

            const headers = data.values[0].map(header => header.trim());
            console.log("ğŸ” ãƒ˜ãƒƒãƒ€ãƒ¼æƒ…å ±:", headers);
            const facilities = data.values.slice(1).map(row => {
                let obj = {};
                headers.forEach((header, index) => {
                    obj[header] = row[index] || "";
                });
                return obj;
            });

            updateMapMarkers(facilities);
        }

        function convertYouTubeEmbed(url) {
            if (!url) return "";

            let videoId = "";
            let originalUrl = url.trim();

            if (originalUrl.includes("youtube.com/watch?v=")) {
                videoId = originalUrl.split("v=")[1].split("&")[0];
            } else if (originalUrl.includes("youtu.be/")) {
                videoId = originalUrl.split("youtu.be/")[1].split("?")[0];
            }

            return {
                embedUrl: videoId ? https://www.youtube.com/embed/${videoId} : "",
                originalUrl: originalUrl
            };
        }

        function updateMapMarkers(facilities) {
            console.log("ğŸ”„ ãƒãƒ¼ã‚«ãƒ¼è¿½åŠ å‡¦ç†é–‹å§‹");

            markers.forEach(marker => marker.setMap(null));
            markers = [];
            bounds = new google.maps.LatLngBounds();

            if (infoWindow) {
                infoWindow.close();
            }

            let markerCount = 0;

            facilities.forEach(facility => {
                console.log("ğŸ“Œ å‡¦ç†ä¸­ã®æ–½è¨­:", facility);

                if (!facility["ç·¯åº¦"] || !facility["çµŒåº¦"]) {
                    console.warn("âš ï¸ ç·¯åº¦ãƒ»çµŒåº¦ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ã¾ã›ã‚“:", facility);
                    return;
                }

                const lat = parseFloat(facility["ç·¯åº¦"]);
                const lng = parseFloat(facility["çµŒåº¦"]);

                if (isNaN(lat) || isNaN(lng)) {
                    console.warn("âš ï¸ æ•°å€¤ã«å¤‰æ›ã§ããªã„ç·¯åº¦ãƒ»çµŒåº¦:", facility["ç·¯åº¦"], facility["çµŒåº¦"]);
                    return;
                }

                const position = new google.maps.LatLng(lat, lng);
                const marker = new google.maps.Marker({
                    position: position,
                    map: map,
                    title: facility["å ´æ‰€"] || "ä¸æ˜"
                });

                markers.push(marker);
                bounds.extend(position);
                markerCount++;

                let { embedUrl, originalUrl } = convertYouTubeEmbed(facility["å‹•ç”»URL"]);

                console.log("ğŸ¥ åŸ‹ã‚è¾¼ã¿å‹•ç”»URL: " + embedUrl);
                console.log("ğŸ”— å…ƒã®å‹•ç”»URL: " + originalUrl);

                marker.addListener("click", function () {
                    if (infoWindow) {
                        infoWindow.close();
                    }

                    infoWindow = new google.maps.InfoWindow({
                        content: 
                            <div class="info-window" style="max-width: 300px; position: relative;">
                                <h2>${facility["å ´æ‰€"] || "æƒ…å ±ãªã—"}</h2>
                                <p><strong>ä½æ‰€:</strong> ${facility["ä½æ‰€"] || "æƒ…å ±ãªã—"}</p>
                                <p>è©³ç´°: ${facility["èª¬æ˜"] || "æƒ…å ±ãªã—"}</p>
                                ${embedUrl ? <iframe src="${embedUrl}" allowfullscreen></iframe> : ""}
                                <p>æ’®å½±æ—¥: ${facility["æ’®å½±æ—¥"] || "æƒ…å ±ãªã—"}</p>
                                <p><a href="${originalUrl}" target="_blank">YouTubeã§é–‹ã</a></p>
                                <p><a href="https://maps.google.com/?q=${facility["ä½æ‰€"]}" target="_blank">Googleãƒãƒƒãƒ—ã§é–‹ã</a></p>
                            </div>
                        
                    });

                    infoWindow.open(map, marker);
                });
            });

            if (markerCount > 0) {
                console.log(âœ… ãƒãƒ¼ã‚«ãƒ¼è¿½åŠ å®Œäº†: ${markerCount} å€‹);
                map.fitBounds(bounds);
            } else {
                console.warn("âš ï¸ æœ‰åŠ¹ãªãƒãƒ¼ã‚«ãƒ¼ãŒã‚ã‚Šã¾ã›ã‚“");
            }
        }
    </script>
</body>
</html>
